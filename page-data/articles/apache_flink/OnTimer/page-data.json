{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/articles/apache_flink/OnTimer",
    "result": {"pageContext":{"data":{"previous":{"slug":"apache_flink/01WhyFlink","frontmatter":{"title":"（一）Why Flink?"}},"next":{"slug":"apache_flink/ParameterTool","frontmatter":{"title":"ParameterTool"}},"node":{"id":"b8a48d69-af28-5203-9d49-1556b6c1c715","frontmatter":{"cover":"https://raw.githubusercontent.com/SpiritGit/SpiritGit.github.io/main/src/images/covers/flink_logo.jpg","date":"2022-07-08","title":"计时器"},"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"计时器\",\n  \"date\": \"2022-07-08T00:00:00.000Z\",\n  \"cover\": \"https://raw.githubusercontent.com/SpiritGit/SpiritGit.github.io/main/src/images/covers/flink_logo.jpg\"\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h2\", null, \"\\u573A\\u666F\\u5047\\u8BBE\\uFF1A\\u4E3A\\u4EC0\\u4E48\\u9700\\u8981\\u8BA1\\u65F6\\u5668\"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"\\u73B0\\u6709\\u4EE5\\u4E0B\\u573A\\u666F\\uFF1A\")), mdx(\"p\", null, \"\\u8F66\\u8F86\\u884C\\u9A76\\u8FC7\\u7A0B\\u4E2D\\u6BCF\\u96945\\u5206\\u949F\\u53D1\\u9001\\u4E00\\u6B21\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"GPS\"), \"\\u5B9A\\u4F4D\\u6570\\u636E\\uFF0C\\u4F46\\u53D7\\u73AF\\u5883\\u6216\\u7F51\\u7EDC\\u5F71\\u54CD\\uFF0C\\u6570\\u636E\\u65F6\\u6709\\u4E22\\u5931\\u3002\\u73B0\\u9700\\u63D0\\u53D6\\u51FA\\u5176\\u5728\\u9AD8\\u901F\\u516C\\u8DEF\\u4EE5\\u5185\\u90E8\\u5206\\uFF0C\\u5E76\\u5C06\\u5176\\u8FDB\\u884C\\u5408\\u5E76\\uFF0C\\u5408\\u5E76\\u539F\\u5219\\u4E3A\\uFF1A\\u4E00\\u6B21\\u901A\\u884C\\u6240\\u4EA7\\u751F\\u7684\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"GPS\"), \"\\u6570\\u636E\\u5408\\u5E76\\u4E3A\\u4E00\\u6761\\u8F68\\u8FF9\\u3002\"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"\\u5173\\u952E\\u70B9\"), \"\\uFF1A\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"1 \\u63D0\\u53D6\\u51FA\\u9AD8\\u901F\\u516C\\u8DEF\\u5185\\u7684\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"GPS\"), \"\\u6570\\u636E\\u3002\\uFF08\\u8BE5\\u5173\\u952E\\u70B9\\u4E0D\\u662F\\u672C\\u7BC7\\u535A\\u5BA2\\u7684\\u4E3B\\u89D2\\uFF0C\\u53C2\\u89C1\", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"/articles/general_algorithm/bitmap\"\n  }, \"\\u901A\\u7528\\u7B97\\u6CD5\\u7BC7\\uFF1A\\u9ED1\\u767D\\u4F4D\\u56FE\\u7B97\\u6CD5\"), \"\\uFF09\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"2 \\u5C06\\u4E0D\\u540C\\u51FA\\u884C\\u7684\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"GPS\"), \"\\u6570\\u636E\\u5207\\u6BB5\\u3002 \")), mdx(\"p\", null, \"\\u5BF9\\u4E8E\\u4E0A\\u8FF0\\u5173\\u952E\\u70B92\\uFF0C\\u53EF\\u91C7\\u53D6\\u7684\\u89E3\\u51B3\\u65B9\\u5F0F\\u4E3A\\uFF1A\\u5F53\\u8F66\\u8F86\\u8FDE\\u7EED\\u53D1\\u9001\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"n\"), \"\\uFF08\\u53EF\\u53D63\\uFF09\\u6B21\\u4E0D\\u5728\\u9AD8\\u901F\\u7684\\u8BB0\\u5F55\\uFF0C\\u6216\\u8DDD\\u79BB\\u6700\\u540E\\u4E00\\u6B21\\u53D1\\u9001\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"GPS\"), \"\\u6570\\u636E\\u5DF2\\u8FC7\\u53BB\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"t\"), \"\\uFF08\\u53EF\\u53D630\\u5206\\u949F\\uFF09\\u65F6\\u95F4\\uFF0C\\u5219\\u8FDB\\u884C\\u622A\\u65AD\\uFF0C\\u5E76\\u5C06\\u524D\\u7EED\\u7684\\u9AD8\\u901F\\u5185\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"GPS\"), \"\\u6570\\u636E\\u8FDB\\u884C\\u5408\\u5E76\\u3002\"), mdx(\"p\", null, \"\\u4E0A\\u8FF0\\u63D0\\u5230\\u7684\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"t\"), \"\\u65F6\\u95F4\\uFF0C\\u5219\\u53EF\\u501F\\u52A9\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"flink\"), \"\\u63D0\\u4F9B\\u7684\\u8BA1\\u65F6\\u5668\\u8FDB\\u884C\\u5B9E\\u73B0\\u3002\"), mdx(\"h2\", null, \"\\u8BA1\\u65F6\\u5668\\u7B80\\u4ECB\"), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Timer\"), \"\\uFF08\\u8BA1\\u65F6\\u5668\\uFF09\\u662F\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"flink streaming api\"), \"\\u63D0\\u4F9B\\u7684\\u7528\\u4E8E\\u611F\\u77E5\\u5E76\\u5229\\u7528\\u5904\\u7406\\u65F6\\u95F4/\\u4E8B\\u4EF6\\u65F6\\u95F4\\u53D8\\u5316\\u7684\\u673A\\u5236\\u3002\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Ververica blog\"), \"\\u4E0A\\u7ED9\\u51FA\\u7684\\u63CF\\u8FF0\\u5982\\u4E0B\\uFF1A\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"Timers are what make Flink streaming applications reactive and adaptable to processing and event time changes.\")), mdx(\"p\", null, \"\\u5BF9\\u4E8E\\u666E\\u901A\\u7528\\u6237\\u6765\\u8BF4\\uFF0C\\u6700\\u5E38\\u89C1\\u7684\\u663E\\u5F0F\\u5229\\u7528\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Timer\"), \"\\u7684\\u5730\\u65B9\\u5C31\\u662F\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"KeyedProcessFunction\"), \"\\u548C\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"CoProcessFunction\"), \"\\uFF08\", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"/articles/apache_flink/ProcessFunction\"\n  }, \"\\u53C2\\u89C1ProcessFunctionAPI\"), \"\\uFF09\\u3002\\u6211\\u4EEC\\u5728\\u5176\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"processElement()\"), \"\\u65B9\\u6CD5\\u4E2D\\u6CE8\\u518C\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Timer\"), \"\\uFF0C\\u7136\\u540E\\u8986\\u5199\\u5176\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"onTimer()\"), \"\\u65B9\\u6CD5\\u4F5C\\u4E3A\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Timer\"), \"\\u89E6\\u53D1\\u65F6\\u7684\\u56DE\\u8C03\\u903B\\u8F91\\u3002\"), mdx(\"h3\", null, \"\\u6CE8\\u518C\\u8BA1\\u65F6\\u5668\"), mdx(\"p\", null, \"\\u9996\\u5148\\u6839\\u636E\\u4E1A\\u52A1\\u5B9A\\u4E49\\u51FA\\u8981\\u6CE8\\u518C\\u7684\\u65F6\\u95F4\\u6233\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"timer\"), \"\\uFF08\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"timer\"), \"\\u4E3A\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"long\"), \"\\u7C7B\\u578B\\uFF0C\\u5373\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"unix\"), \"\\u65F6\\u95F4\\u6233\\uFF0C\\u5F53\\u7CFB\\u7EDF\\u65F6\\u95F4\\u6216\\u6C34\\u4F4D\\u7EBF\\u5230\\u8FBE\\u8BE5\\u65F6\\u95F4\\u6233\\u662F\\u4F1A\\u51FA\\u53D1\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"onTimer()\"), \"\\u65B9\\u6CD5\\uFF09\\n\\u6839\\u636E\\u65F6\\u95F4\\u7279\\u5F81\\u7684\\u4E0D\\u540C\\uFF0C\\u6CE8\\u518C\\u8BA1\\u65F6\\u5668\\u65B9\\u6CD5\\u5982\\u4E0B\\uFF1A\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u5904\\u7406\\u65F6\\u95F4\\u2014\\u2014\\u8C03\\u7528\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Context.timerService().registerProcessingTimeTimer(timer)\"), \"\\u6CE8\\u518C\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u4E8B\\u4EF6\\u65F6\\u95F4\\u2014\\u2014\\u8C03\\u7528\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Context.timerService().registerEventTimeTimer(timer)\"), \"\\u6CE8\\u518C\")), mdx(\"h3\", null, \"\\u5220\\u9664\\u8BA1\\u65F6\\u5668\"), mdx(\"p\", null, \"\\u9996\\u5148\\u83B7\\u53D6\\u5F53\\u524D\\u8BA1\\u65F6\\u5668\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"timer\"), \"\\n\\u5176\\u6B21\\u5220\\u9664\\u8BA1\\u65F6\\u5668\\uFF0C\\u6839\\u636E\\u65F6\\u95F4\\u7279\\u5F81\\u4E0D\\u540C\\uFF0C\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u5904\\u7406\\u65F6\\u95F4\\u2014\\u2014\\u8C03\\u7528 \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"ctx.timerService().deleteProcessingTimeTimer(timer)\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u4E8B\\u4EF6\\u65F6\\u95F4\\u2014\\u2014\\u8C03\\u7528\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"ctx.timerService().deleteEventTimeTimer(timer)\"))), mdx(\"h3\", null, \"\\u89E6\\u53D1\\u8BA1\\u65F6\\u5668\"), mdx(\"p\", null, \"\\u6839\\u636E\\u65F6\\u95F4\\u7279\\u5F81\\u7684\\u4E0D\\u540C\\uFF0C\\u6CE8\\u518C\\u8BA1\\u65F6\\u5668\\u65B9\\u6CD5\\u5982\\u4E0B\\uFF1A\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u5904\\u7406\\u65F6\\u95F4\\u2014\\u2014\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"onTimer()\"), \"\\u5728\\u7CFB\\u7EDF\\u65F6\\u95F4\\u6233\\u8FBE\\u5230\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Timer\"), \"\\u8BBE\\u5B9A\\u7684\\u65F6\\u95F4\\u6233\\u65F6\\u81EA\\u52A8\\u89E6\\u53D1\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"\\u4E8B\\u4EF6\\u65F6\\u95F4\\u2014\\u2014\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"onTimer()\"), \"\\u5728\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Flink\"), \"\\u5185\\u90E8\\u6C34\\u5370\\u8FBE\\u5230\\u6216\\u8D85\\u8FC7\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Timer\"), \"\\u8BBE\\u5B9A\\u7684\\u65F6\\u95F4\\u6233\\u65F6\\u81EA\\u52A8\\u89E6\\u53D1\")), mdx(\"h2\", null, \"\\u5229\\u7528\", mdx(\"inlineCode\", {\n    parentName: \"h2\"\n  }, \"CoProcessFunction\"), \" + \", mdx(\"inlineCode\", {\n    parentName: \"h2\"\n  }, \"Timer\"), \"\\u89E3\\u51B3\\u4E0A\\u8FF0\\u95EE\\u9898\"), mdx(\"p\", null, \"\\u524D\\u7EED\\u5224\\u522B\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"GPS\"), \"\\u6570\\u636E\\u662F\\u5426\\u5728\\u9AD8\\u901F\\u7684\\u6B65\\u9AA4\\u6B64\\u5904\\u7565\\u53BB\\uFF0C\\u5F97\\u5230\\u7ED3\\u679C\\u4E3A\\u4F4D\\u4E8E\\u9AD8\\u901F\\u7684\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"DataStream\"), \"\\u548C\\u975E\\u9AD8\\u901F\\u7684\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"DataStream\"), \"\\u7684\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"GPS\"), \"\\u6570\\u636E\\uFF0C\\u7531\\u4E8E\\u4E24\\u6761\\u6570\\u636E\\u6D41\\u90FD\\u4F1A\\u88AB\\u8F68\\u8FF9\\u5207\\u5206\\u6240\\u7528\\u5230\\uFF0C\\u56E0\\u6B64\\u5C06\\u4E24\\u6761\\u6570\\u636E\\u6D41\\u5408\\u5E76\\u5F97\\u5230\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ConnectedStreams\"), \"\\uFF0C\\u8FDB\\u4E00\\u6B65\\u8FDB\\u884C\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"KeyBy\"), \"\\u5206\\u7EC4\\u540E\\u4F20\\u5165\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"CoProcessFunction\"), \"\\uFF0C\\u4ECE\\u800C\\u5B9E\\u73B0\\u8F68\\u8FF9\\u5207\\u5206\\u5E76\\u8F93\\u51FA\\u5B8C\\u6574\\u7684\\u9AD8\\u901F\\u901A\\u884C\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"GPS\"), \"\\u8F68\\u8FF9\\uFF0C\\u4EE3\\u7801\\u5B9E\\u73B0\\u5982\\u4E0B\\u3002\"), mdx(\"deckgo-highlight-code\", {\n    \"language\": \"java\",\n    \"theme\": \"one-dark\"\n  }, \"\\n          \", mdx(\"code\", {\n    parentName: \"deckgo-highlight-code\",\n    \"slot\": \"code\"\n  }, \"public class TraceCut extends CoProcessFunction<Map, Map, Map<String, TreeSet<GPSBean>>> {\\n    private ValueState<TreeSet<GPSBean>> routeState; // \\u4FDD\\u5B58\\u5728\\u9AD8\\u901F\\u7684GPS\\u6570\\u636E\\n    private ValueState<String> outOfHighwayTimes; // \\u4FDD\\u5B58\\u8FDE\\u7EED\\u51FA\\u73B0\\u975E\\u9AD8\\u901FGPS\\u6570\\u636E\\u6B21\\u6570\\n    private ValueState<Long> timerState; // \\u4FDD\\u5B58\\u8BA1\\u65F6\\u5668\\u7684\\u65F6\\u95F4\\u6233\\n\\n    @Override\\n    public void open(Configuration parameters) throws Exception {\\n        ValueStateDescriptor stateDescriptor1 = new ValueStateDescriptor<>(\\\"route state\\\", GPSBean.class);\\n        routeState = getRuntimeContext().getState(stateDescriptor1);\\n\\n        ValueStateDescriptor stateDescriptor2 = new ValueStateDescriptor<>(\\\"contiously out of hw times\\\", String.class);\\n        outOfHighwayTimes = getRuntimeContext().getState(stateDescriptor2);\\n\\n        ValueStateDescriptor stateDescriptor3 = new ValueStateDescriptor<>(\\\"last gps time\\\", Types.LONG);\\n        timerState = getRuntimeContext().getState(stateDescriptor3);\\n    }\\n\\n    @Override\\n    public void processElement1(Map onHwData, CoProcessFunction<Map, Map, Map<String, TreeSet<GPSBean>>>.Context ctx,\\n            Collector<Map<String, TreeSet<GPSBean>>> out) throws Exception {\\n\\n        // \\u521D\\u59CB\\u5316\\u5BF9\\u8C61\\n        String veh_plate = onHwData.get(\\\"veh_plate\\\").toString();\\n        String recordtime = onHwData.get(\\\"recordtime\\\").toString();\\n        String longitude = onHwData.get(\\\"longitude\\\").toString();\\n        String latitude = onHwData.get(\\\"latitude\\\").toString();\\n        String altitude = onHwData.get(\\\"altitude\\\").toString();\\n        String direction = onHwData.get(\\\"direction\\\").toString();\\n        String speed = onHwData.get(\\\"speed\\\").toString();\\n\\n        SimpleDateFormat sdf = new SimpleDateFormat(\\\"yyyy-MM-dd HH:mm:ss\\\");\\n        sdf.setTimeZone(TimeZone.getTimeZone(\\\"Asia/Shanghai\\\"));\\n        Date dateTime = sdf.parse(recordtime);\\n        long timeLong = dateTime.getTime();\\n\\n\\n        GPSBean currentObj =  new GPSBean(veh_plate, recordtime, longitude, latitude, altitude,\\n        direction, speed, timeLong);\\n\\n        // \\u83B7\\u53D6\\u72B6\\u6001\\n        TreeSet<GPSBean> curRoute = routeState.value();\\n        String curTimesStr = outOfHighwayTimes.value();\\n\\n        // \\u6E05\\u9664\\u524D\\u5E8F\\u4E0D\\u5728\\u9AD8\\u901F\\u4E0B\\u7684\\u6B21\\u6570\\u8BB0\\u5F55\\n        if (curTimesStr != null) {\\n            outOfHighwayTimes.clear();\\n        }\\n\\n        if (curRoute == null) {\\n            System.out.println(\\\"new route ===============\\\");\\n            TreeSet<GPSBean> newTreeSet = new TreeSet<>(); //\\u65B0\\u5EFA\\u8F68\\u8FF9\\n            newTreeSet.add(currentObj);\\n            routeState.update(newTreeSet);\\n            long timer = ctx.timerService().currentProcessingTime() + StaticParameter.outOfHwMillSeconds; //\\u5F53\\u524D\\u65F6\\u95F4 + \\u6307\\u5B9A\\u7684\\u5EF6\\u8FDF\\u65F6\\u95F4\\n            ctx.timerService().registerProcessingTimeTimer(timer); //\\u4F7F\\u7528\\u4E0A\\u4E00\\u884C\\u4E2D timer \\u6CE8\\u518C\\u8BA1\\u65F6\\u5668\\uFF0Ctimer\\u65F6\\u95F4\\u5185\\u65E0\\u65B0\\u7684\\u5728\\u9AD8\\u901F\\u5185\\u7684\\u6570\\u636E\\uFF0C\\u5219\\u5230\\u671F\\n            timerState.update(timer);\\n        } else {\\n            System.out.println(\\\"add route +++++++++++++\\\");\\n            curRoute.add(currentObj); //\\u8FFD\\u52A0\\u8F68\\u8FF9\\n            routeState.update(curRoute);\\n\\n            long lastTimer = timerState.value();\\n            ctx.timerService().deleteProcessingTimeTimer(lastTimer); //\\u5220\\u9664\\u539F\\u5B9A\\u65F6\\u5668\\n            long timer = ctx.timerService().currentProcessingTime() + StaticParameter.outOfHwMillSeconds;\\n            ctx.timerService().registerProcessingTimeTimer(timer);// \\u65B0\\u8BBE\\u7F6E30\\u5206\\u949F\\u5B9A\\u65F6\\u5668\\n            timerState.update(timer);\\n        } \\n    }\\n\\n    @Override\\n    public void processElement2(Map notOnHwData, CoProcessFunction<Map, Map, Map<String, TreeSet<GPSBean>>>.Context ctx,\\n            Collector<Map<String, TreeSet<GPSBean>>> out) throws Exception {\\n\\n        String curTimesStr = outOfHighwayTimes.value();\\n        TreeSet<GPSBean> curRoute = routeState.value();\\n\\n        int curTimes; \\n\\n        // \\u82E5\\u6709\\u524D\\u5E8F\\u5728\\u9AD8\\u901F\\u4E0A\\u7684\\u8BB0\\u5F55\\uFF0C\\u5219 \\u8FDE\\u7EED\\u9AD8\\u901F\\u4E0Bgps\\u6B21\\u6570 + 1\\uFF0C \\u5426\\u5219\\u4E0D\\u4FDD\\u5B58\\u72B6\\u6001\\n        if (curRoute != null) {\\n            //\\u8FDE\\u7EED\\u51FA\\u73B0\\u9AD8\\u901F\\u4E0Bgps\\u6B21\\u6570 + 1\\n            if (curTimesStr  == null) {\\n                curTimes = 1;\\n            } else {\\n                curTimes = Integer.valueOf(curTimesStr) + 1;\\n            }\\n\\n            // \\u8FBE\\u5230\\u8F68\\u8FF9\\u5207\\u5206\\u9608\\u503C\\uFF08\\u8FDE\\u7EED\\u51FA\\u73B0\\u9AD8\\u901F\\u4E0Bgps n \\u6B21\\uFF09\\n            if ( curTimes == StaticParameter.timesForCut ) {\\n\\n                System.out.println(\\\"n times out of hw\\\");\\n\\n                Map wholeRoute = new HashMap<>();\\n                wholeRoute.put(\\\"jshw_trace:\\\",curRoute);\\n\\n                System.out.println(\\\"size: \\\" + curRoute.size());\\n                System.out.println(wholeRoute);\\n\\n                out.collect(wholeRoute);\\n\\n                String vpn = curRoute.first().getVeh_plate();\\n                JedisCluster jedisCluster = FlinkRedisConn.getJedisCluster(); //\\u96C6\\u7FA4\\n                jedisCluster.del(\\\"taisl:lkyw:gps:\\\" + vpn); //\\u5220\\u9664redis\\u5B9E\\u65F6\\u8F68\\u8FF9\\n                jedisCluster.close();\\n\\n                routeState.clear(); //\\u6E05\\u9664\\u8F68\\u8FF9\\u72B6\\u6001\\n                outOfHighwayTimes.clear();\\n                timerState.clear();\\n            } else {\\n                System.out.println(\\\"out of hw times: \\\" + String.valueOf(curTimes));\\n                outOfHighwayTimes.update(String.valueOf(curTimes));\\n\\n                long lastTimer = timerState.value();\\n                ctx.timerService().deleteProcessingTimeTimer(lastTimer); //\\u5220\\u9664\\u539F\\u5B9A\\u65F6\\u5668\\n                long timer = ctx.timerService().currentProcessingTime() + StaticParameter.outOfHwMillSeconds;\\n                ctx.timerService().registerProcessingTimeTimer(timer);// \\u65B0\\u8BBE\\u7F6E30\\u5206\\u949F\\u5B9A\\u65F6\\u5668\\n                timerState.update(timer);\\n            }\\n        }\\n    }\\n\\n    @Override\\n    public void onTimer(long timestamp, OnTimerContext ctx,\\n            Collector<Map<String, TreeSet<GPSBean>>> out) throws Exception {\\n\\n        TreeSet<GPSBean> firedRoute = routeState.value();\\n        \\n        if (firedRoute != null) {\\n\\n            System.out.println(\\\"timer fired!\\\");\\n\\n            Map wholeRoute = new HashMap<>();\\n            wholeRoute.put(\\\"jshw_trace:\\\",firedRoute);\\n            out.collect(wholeRoute);\\n            routeState.clear(); //\\u6E05\\u9664\\u8F68\\u8FF9\\u72B6\\u6001\\n\\n            String vpn = firedRoute.first().getVeh_plate();\\n            JedisCluster jedisCluster = FlinkRedisConn.getJedisCluster(); //\\u96C6\\u7FA4\\n            jedisCluster.del(\\\"taisl:lkyw:gps:\\\" + vpn); //\\u5220\\u9664redis\\u5B9E\\u65F6\\u8F68\\u8FF9\\n            jedisCluster.close();\\n        }\\n        \\n        outOfHighwayTimes.clear(); //\\u5220\\u9664\\u51FA\\u9AD8\\u901F\\u8BA1\\u6570\\u5668\\n        timerState.clear();\\n    }\\n}\"), \"\\n        \"));\n}\n;\nMDXContent.isMDXComponent = true;","slug":"apache_flink/OnTimer","wordCount":{"sentences":26}}},"next":{"slug":"apache_flink/ParameterTool","frontmatter":{"title":"ParameterTool"}},"previous":{"slug":"apache_flink/01WhyFlink","frontmatter":{"title":"（一）Why Flink?"}}}},
    "staticQueryHashes": ["2757060725","3605573801"]}